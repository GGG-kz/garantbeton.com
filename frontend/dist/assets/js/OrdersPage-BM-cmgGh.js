import{a as e,j as s,u as t,P as r}from"./index-DssK2aQr.js";import{r as n}from"./vendor-CPG67Noa.js";import{E as a,O as i,a as o,b as l,c as d}from"./orders-wRWCNCfU.js";import{Q as c,i as m,P as x,O as u,b as h,a as p,l as j,A as v,V as N,T as b,Z as f,N as g,_ as y,q as w,G as k}from"./ui-DT0cN5GG.js";import{V as S}from"./ViewToggle-BZCXPk9z.js";import"./utils-CHM7ATol.js";import"./forms-BH-hazHY.js";const I=[],C=[],D=[];function O({isOpen:t,onClose:r,onSave:i,order:o,title:l,userRole:d}){const[x]=e("counterparties",I),[u]=e("concreteGrades",C),[h]=e("warehouses",D),[p]=e("additionalServices",a),[j,v]=n.useState({customerId:"",concreteGradeId:"",quantity:0,warehouseId:"",deliveryObject:"",deliveryAddress:"",deliveryDateTime:"",price:void 0,additionalServices:[],priority:"low",notes:""}),[N,b]=n.useState({}),[f,g]=n.useState(""),y="director"===d||"accountant"===d||"manager"===d,w="director"===d||"accountant"===d||"manager"===d;n.useEffect(()=>{v(o?{customerId:o.customerId,concreteGradeId:o.concreteGradeId,quantity:o.quantity,warehouseId:o.warehouseId,deliveryObject:o.deliveryObject,deliveryAddress:o.deliveryAddress,deliveryDateTime:o.deliveryDateTime,price:o.price,additionalServices:o.additionalServices,priority:o.priority,notes:o.notes||""}:{customerId:"",concreteGradeId:"",quantity:0,warehouseId:"",deliveryObject:"",deliveryAddress:"",deliveryDateTime:"",price:void 0,additionalServices:[],priority:"low",notes:""}),b({})},[o,t]);const k=(e,s)=>{v(t=>{const r={...t,[e]:s};if("quantity"===e){const e=r.additionalServices.map(e=>{const t=p.find(s=>s.id===e.serviceId);return t&&"per_m3"===t.unit?{...e,quantity:s,total:e.pricePerUnit*s}:e});r.additionalServices=e}return r}),N[e]&&b(s=>({...s,[e]:""}))};return t?s.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4",children:s.jsx("div",{className:"bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:s.jsxs("div",{className:"p-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold text-mono-900",children:l}),s.jsxs("button",{onClick:r,className:"text-mono-400 hover:text-mono-600 transition-colors duration-200",children:[s.jsx("span",{className:"sr-only",children:"Закрыть"}),s.jsx("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]})]}),s.jsxs("form",{onSubmit:e=>{e.preventDefault();const s={};j.customerId||(s.customerId="Выберите покупателя"),j.concreteGradeId||(s.concreteGradeId="Выберите марку бетона"),j.quantity<=0&&(s.quantity="Количество должно быть больше 0"),j.warehouseId||(s.warehouseId="Выберите склад"),j.deliveryObject.trim()||(s.deliveryObject="Укажите объект доставки"),j.deliveryAddress.trim()||(s.deliveryAddress="Укажите адрес доставки"),j.deliveryDateTime||(s.deliveryDateTime="Укажите дату и время доставки"),b(s),0===Object.keys(s).length&&i(j)},className:"space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-mono-700 mb-2",children:["Покупатель ",s.jsx("span",{className:"text-mono-500",children:"*"})]}),s.jsxs("select",{value:j.customerId,onChange:e=>k("customerId",e.target.value),className:"w-full px-3 py-2 border border-mono-300 rounded-md focus:outline-none focus:ring-2 focus:ring-mono-500 focus:border-mono-500",children:[s.jsx("option",{value:"",children:"Выберите покупателя"}),x.filter(e=>"client"===e.type&&e.isActive).map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]}),N.customerId&&s.jsx("p",{className:"mt-1 text-sm text-mono-600",children:N.customerId})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-mono-700 mb-2",children:["Марка бетона ",s.jsx("span",{className:"text-mono-500",children:"*"})]}),s.jsxs("select",{value:j.concreteGradeId,onChange:e=>k("concreteGradeId",e.target.value),className:"w-full px-3 py-2 border border-mono-300 rounded-md focus:outline-none focus:ring-2 focus:ring-mono-500 focus:border-mono-500",children:[s.jsx("option",{value:"",children:"Выберите марку бетона"}),u.filter(e=>e.isActive).map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]}),N.concreteGradeId&&s.jsx("p",{className:"mt-1 text-sm text-mono-600",children:N.concreteGradeId})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-mono-700 mb-2",children:["Количество (м³) ",s.jsx("span",{className:"text-mono-500",children:"*"})]}),s.jsx("input",{type:"number",min:"0",step:"0.1",value:j.quantity,onChange:e=>k("quantity",parseFloat(e.target.value)||0),className:"w-full px-3 py-2 border border-mono-300 rounded-md focus:outline-none focus:ring-2 focus:ring-mono-500 focus:border-mono-500"}),N.quantity&&s.jsx("p",{className:"mt-1 text-sm text-mono-600",children:N.quantity})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-mono-700 mb-2",children:["Склад ",s.jsx("span",{className:"text-mono-500",children:"*"})]}),s.jsxs("select",{value:j.warehouseId,onChange:e=>k("warehouseId",e.target.value),className:"w-full px-3 py-2 border border-mono-300 rounded-md focus:outline-none focus:ring-2 focus:ring-mono-500 focus:border-mono-500",children:[s.jsx("option",{value:"",children:"Выберите склад"}),h.filter(e=>e.isActive).map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]}),N.warehouseId&&s.jsx("p",{className:"mt-1 text-sm text-mono-600",children:N.warehouseId})]})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-mono-700 mb-2",children:["Объект доставки ",s.jsx("span",{className:"text-mono-500",children:"*"})]}),s.jsx("input",{type:"text",value:j.deliveryObject,onChange:e=>k("deliveryObject",e.target.value),className:"w-full px-3 py-2 border border-mono-300 rounded-md focus:outline-none focus:ring-2 focus:ring-mono-500 focus:border-mono-500",placeholder:"Например: Строительство жилого дома"}),N.deliveryObject&&s.jsx("p",{className:"mt-1 text-sm text-mono-600",children:N.deliveryObject})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-mono-700 mb-2",children:["Адрес доставки ",s.jsx("span",{className:"text-mono-500",children:"*"})]}),s.jsx("input",{type:"text",value:j.deliveryAddress,onChange:e=>k("deliveryAddress",e.target.value),className:"w-full px-3 py-2 border border-mono-300 rounded-md focus:outline-none focus:ring-2 focus:ring-mono-500 focus:border-mono-500",placeholder:"Скопируйте адрес из 2ГИС"}),N.deliveryAddress&&s.jsx("p",{className:"mt-1 text-sm text-mono-600",children:N.deliveryAddress})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-mono-700 mb-2",children:["Дата и время доставки ",s.jsx("span",{className:"text-mono-500",children:"*"})]}),s.jsx("input",{type:"datetime-local",value:j.deliveryDateTime,onChange:e=>k("deliveryDateTime",e.target.value),className:"w-full px-3 py-2 border border-mono-300 rounded-md focus:outline-none focus:ring-2 focus:ring-mono-500 focus:border-mono-500"}),N.deliveryDateTime&&s.jsx("p",{className:"mt-1 text-sm text-mono-600",children:N.deliveryDateTime})]}),y&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700 mb-2",children:"Цена за м³ (₸)"}),s.jsx("input",{type:"number",min:"0",step:"0.01",value:j.price||"",onChange:e=>k("price",parseFloat(e.target.value)||void 0),className:"w-full px-3 py-2 border border-mono-300 rounded-md focus:outline-none focus:ring-2 focus:ring-mono-500 focus:border-mono-500"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700 mb-2",children:"Дополнительные услуги"}),s.jsxs("div",{className:"flex gap-2 mb-4",children:[s.jsxs("select",{value:f,onChange:e=>g(e.target.value),className:"flex-1 px-3 py-2 border border-mono-300 rounded-md focus:outline-none focus:ring-2 focus:ring-mono-500 focus:border-mono-500",children:[s.jsx("option",{value:"",children:"Выберите услугу"}),p.map(e=>s.jsxs("option",{value:e.id,children:[e.name,w?` - ${e.price} ₸/${"fixed"===e.unit?"заказ":e.unit}`:""]},e.id))]}),s.jsx("button",{type:"button",onClick:()=>{if(!f)return;const e=p.find(e=>e.id===f);if(!e)return;if(j.additionalServices.some(e=>e.serviceId===f))return void alert("Эта услуга уже добавлена");const s="per_m3"===e.unit?j.quantity:1,t={serviceId:e.id,serviceName:e.name,quantity:s,pricePerUnit:e.price,unit:e.unit,total:e.price*s};k("additionalServices",[...j.additionalServices,t]),g("")},disabled:!f,className:"px-4 py-2 bg-black text-white rounded-md hover:bg-black disabled:bg-mono-400 disabled:cursor-not-allowed transition-colors duration-200",children:s.jsx(c,{className:"h-4 w-4"})})]}),j.additionalServices.length>0&&s.jsxs("div",{className:"space-y-2",children:[j.additionalServices.map(e=>s.jsxs("div",{className:"flex items-center justify-between p-3 bg-mono-50 rounded-lg",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"font-medium text-mono-900",children:e.serviceName}),s.jsx("div",{className:"text-sm text-mono-600",children:w?`${e.pricePerUnit} ₸/${"fixed"===p.find(s=>s.id===e.serviceId)?.unit?"заказ":"м³"}`:"Цена скрыта"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:["per_m3"===p.find(s=>s.id===e.serviceId)?.unit?s.jsxs("span",{className:"text-sm text-mono-600",children:[e.quantity," м³ ",s.jsx("span",{className:"text-xs text-mono-500",children:"(автоматически по количеству бетона)"})]}):s.jsx("input",{type:"number",min:"1",value:e.quantity,onChange:s=>((e,s)=>{const t=j.additionalServices.map(t=>t.serviceId===e?{...t,quantity:s,total:t.pricePerUnit*s}:t);k("additionalServices",t)})(e.serviceId,parseInt(s.target.value)||1),className:"w-20 px-2 py-1 text-sm border border-mono-300 rounded focus:outline-none focus:ring-1 focus:ring-mono-500"}),s.jsx("span",{className:"text-sm font-medium text-mono-900",children:w?`${e.total.toLocaleString("ru-RU")} ₸`:"Сумма скрыта"}),s.jsx("button",{type:"button",onClick:()=>{return s=e.serviceId,void k("additionalServices",j.additionalServices.filter(e=>e.serviceId!==s));var s},className:"text-mono-600 hover:text-red-800 transition-colors duration-200",children:s.jsx(m,{className:"h-4 w-4"})})]})]},e.serviceId)),s.jsxs("div",{className:"flex justify-between items-center p-3 bg-mono-50 rounded-lg",children:[s.jsx("span",{className:"font-medium text-mono-900",children:"Итого по услугам:"}),s.jsx("span",{className:"font-bold text-black",children:w?`${j.additionalServices.reduce((e,s)=>e+s.total,0).toLocaleString("ru-RU")} ₸`:"Сумма скрыта"})]})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700 mb-2",children:"Примечания"}),s.jsx("textarea",{value:j.notes,onChange:e=>k("notes",e.target.value),rows:3,className:"w-full px-3 py-2 border border-mono-300 rounded-md focus:outline-none focus:ring-2 focus:ring-mono-500 focus:border-mono-500",placeholder:"Дополнительная информация..."})]}),s.jsxs("div",{className:"flex justify-end gap-3 pt-6 border-t border-mono-200",children:[s.jsx("button",{type:"button",onClick:r,className:"px-4 py-2 text-mono-700 bg-mono-100 rounded-md hover:bg-mono-200 transition-colors duration-200",children:"Отмена"}),s.jsx("button",{type:"submit",className:"px-4 py-2 bg-black text-white rounded-md hover:bg-black transition-colors duration-200",children:o?"Сохранить изменения":"Создать заказ"})]})]})]})})}):null}const q=[],A=[],L=[],T=[];function G(){const{user:I}=t();if(!("manager"===I?.role||"director"===I?.role||"dispatcher"===I?.role||"accountant"===I?.role))return s.jsx(r,{title:"Заказы бетона",children:s.jsx("div",{className:"p-8 text-center",children:s.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6 max-w-md mx-auto",children:[s.jsx("div",{className:"text-mono-600 text-6xl mb-4",children:"🚫"}),s.jsx("h2",{className:"text-xl font-semibold text-red-800 mb-2",children:"Доступ запрещён"}),s.jsx("p",{className:"text-mono-600",children:"У вас нет прав для просмотра заказов бетона. Доступ разрешён только для менеджеров, директоров, диспетчеров и бухгалтеров."})]})})});const[C,D]=e("orders",q),[G,U]=e("ordersViewMode","list"),[P]=e("counterparties",A),[R]=e("concreteGrades",L),[$]=e("warehouses",T);e("additionalServices",a);const[V,B]=n.useState(""),[M,_]=n.useState("all"),[z,E]=n.useState("all"),[F,W]=n.useState(!1),[Q,Z]=n.useState(null),[H,J]=n.useState(null),K="director"===I?.role||"accountant"===I?.role||"manager"===I?.role,X=C.filter(e=>{if("manager"===I?.role&&e.createdBy!==I?.id)return!1;const s=e.customerName.toLowerCase().includes(V.toLowerCase())||e.deliveryObject.toLowerCase().includes(V.toLowerCase())||e.deliveryAddress.toLowerCase().includes(V.toLowerCase())||e.concreteGradeName.toLowerCase().includes(V.toLowerCase()),t="all"===M||e.status===M,r="all"===z||e.priority===z;return s&&t&&r&&e.isActive}),Y=e=>{switch(e){case"pending":default:return s.jsx(k,{className:"h-4 w-4"});case"confirmed":case"delivered":case"completed":return s.jsx(j,{className:"h-4 w-4"});case"in_production":return s.jsx(x,{className:"h-4 w-4"});case"ready":return s.jsx(b,{className:"h-4 w-4"});case"cancelled":return s.jsx(v,{className:"h-4 w-4"})}},ee=e=>{"director"===I?.role||"accountant"===I?.role?(Z(e),W(!0)):alert("У вас нет прав для редактирования заказов. Редактировать могут только директор и бухгалтер.")},se=e=>{J(e)},te=e=>{if(!C.find(s=>s.id===e))return;"director"===I?.role||"accountant"===I?.role?window.confirm("Вы уверены, что хотите удалить этот заказ?")&&D(s=>s.map(s=>s.id===e?{...s,isActive:!1}:s)):alert("У вас нет прав для удаления заказов. Удалять могут только директор и бухгалтер.")},re=e=>{window.confirm('Подтвердить заявку и перевести в статус "Подтверждён"?')&&D(s=>s.map(s=>s.id===e.id?{...s,status:"confirmed",updatedAt:(new Date).toISOString()}:s))},ne=e=>{const s=prompt(`Установить приоритет для заказа #${e.id}:\n\n1 - Низкий\n2 - Средний\n3 - Высокий\n4 - Срочный\n\nВведите номер (1-4):`);if(s){const t={1:"low",2:"medium",3:"high",4:"urgent"}[s];t?D(s=>s.map(s=>s.id===e.id?{...s,priority:t,updatedAt:(new Date).toISOString()}:s)):alert("Неверный номер приоритета. Введите число от 1 до 4.")}};return s.jsx(r,{title:"Заказы бетона",subtitle:"Управление заказами на производство и доставку бетона",children:s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsxs("div",{className:"flex items-center space-x-4",children:[s.jsx(x,{className:"h-8 w-8 text-primary-600"}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-2xl font-bold text-mono-900",children:"Заказы бетона"}),s.jsxs("p",{className:"text-mono-600",children:["Всего: ",X.length]})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(S,{viewMode:G,onViewModeChange:U}),s.jsxs("button",{onClick:()=>{Z(null),W(!0)},className:"flex items-center space-x-2 px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors duration-200",children:[s.jsx(c,{className:"h-4 w-4"}),s.jsx("span",{children:"Создать заказ"})]})]})]}),s.jsx("div",{className:"bg-white rounded-lg border border-mono-200 p-4",children:s.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[s.jsx("div",{className:"flex-1",children:s.jsxs("div",{className:"relative",children:[s.jsx(u,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-mono-400"}),s.jsx("input",{type:"text",placeholder:"Поиск по покупателю, объекту, адресу...",value:V,onChange:e=>B(e.target.value),className:"w-full pl-10 pr-4 py-2 border border-mono-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"})]})}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("select",{value:M,onChange:e=>_(e.target.value),className:"px-3 py-2 border border-mono-300 rounded-lg focus:ring-2 focus:ring-mono-500 focus:border-transparent",children:[s.jsx("option",{value:"all",children:"Все статусы"}),Object.entries(i).map(([e,t])=>s.jsx("option",{value:e,children:t},e))]}),s.jsxs("select",{value:z,onChange:e=>E(e.target.value),className:"px-3 py-2 border border-mono-300 rounded-lg focus:ring-2 focus:ring-mono-500 focus:border-transparent",children:[s.jsx("option",{value:"all",children:"Все приоритеты"}),Object.entries(o).map(([e,t])=>s.jsx("option",{value:e,children:t},e))]})]})]})}),0===X.length?s.jsxs("div",{className:"text-center py-12",children:[s.jsx(x,{className:"h-12 w-12 text-mono-400 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-medium text-mono-900 mb-2",children:"Заказы не найдены"}),s.jsx("p",{className:"text-mono-500",children:0===C.length?"Создайте первый заказ для начала работы":"Попробуйте изменить параметры поиска"})]}):"list"===G?s.jsx("div",{className:"bg-white rounded-lg border border-mono-200 overflow-hidden",children:s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[s.jsx("thead",{className:"bg-mono-50",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-mono-500 uppercase tracking-wider",children:"Заказ"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-mono-500 uppercase tracking-wider",children:"Покупатель"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-mono-500 uppercase tracking-wider",children:"Марка / Количество"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-mono-500 uppercase tracking-wider",children:"Склад"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-mono-500 uppercase tracking-wider",children:"Доставка"}),K&&s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-mono-500 uppercase tracking-wider",children:"Цена"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-mono-500 uppercase tracking-wider",children:"Статус"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-mono-500 uppercase tracking-wider",children:"Создатель"}),s.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-mono-500 uppercase tracking-wider",children:"Действия"})]})}),s.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:X.map(e=>s.jsxs("tr",{className:"hover:bg-mono-50",children:[s.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[s.jsxs("div",{className:"text-sm font-medium text-mono-900",children:["#",e.id]}),s.jsx("div",{className:"text-sm text-mono-500",children:e.deliveryObject})]}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsx("div",{className:"text-sm text-mono-900",children:e.customerName})}),s.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[s.jsx("div",{className:"text-sm text-mono-900",children:e.concreteGradeName}),s.jsxs("div",{className:"text-sm text-mono-500",children:[e.quantity," м³"]})]}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsx("div",{className:"text-sm text-mono-900",children:e.warehouseName})}),s.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[s.jsx("div",{className:"text-sm text-mono-900",children:new Date(e.deliveryDateTime).toLocaleDateString("ru-RU")}),s.jsx("div",{className:"text-sm text-mono-500",children:new Date(e.deliveryDateTime).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})})]}),K&&s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-mono-900",children:e.totalPrice?`${e.totalPrice.toLocaleString("ru-RU")} ₸`:"—"}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${l[e.status]}`,children:[Y(e.status),s.jsx("span",{className:"ml-1",children:i[e.status]})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-mono-900",children:s.jsxs("div",{className:"flex items-center",children:[s.jsx(h,{className:"h-4 w-4 text-mono-400 mr-2"}),s.jsx("span",{children:e.createdByName})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:s.jsxs("div",{className:"flex justify-end space-x-2",children:[s.jsx("button",{onClick:()=>se(e),className:"text-black hover:text-black",title:"Просмотр",children:s.jsx(p,{className:"h-4 w-4"})}),"director"===I?.role&&"pending"===e.status&&s.jsx("button",{onClick:()=>re(e),className:"text-mono-600 hover:text-green-900",title:"Подтвердить заявку",children:s.jsx(j,{className:"h-4 w-4"})}),"director"===I?.role&&"pending"===e.status&&s.jsx("button",{onClick:()=>ne(e),className:"text-orange-600 hover:text-orange-900",title:"Установить приоритет",children:s.jsx(v,{className:"h-4 w-4"})}),("director"===I?.role||"accountant"===I?.role)&&"pending"===e.status&&s.jsx("button",{onClick:()=>ee(e),className:"text-indigo-600 hover:text-indigo-900",title:"Редактировать",children:s.jsx(N,{className:"h-4 w-4"})}),("director"===I?.role||"accountant"===I?.role)&&"pending"===e.status&&s.jsx("button",{onClick:()=>te(e.id),className:"text-mono-600 hover:text-red-900",title:"Удалить",children:s.jsx(m,{className:"h-4 w-4"})})]})})]},e.id))})]})})}):s.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6",children:X.map(e=>s.jsxs("div",{className:"bg-white rounded-lg border border-mono-200 p-6 hover:shadow-lg transition-shadow duration-200 relative",children:[s.jsxs("div",{className:"absolute top-4 right-4 flex items-center gap-1",children:[s.jsx("button",{onClick:()=>se(e),className:"p-1 text-black hover:text-black rounded hover:bg-mono-50 transition-colors duration-200",title:"Просмотр",children:s.jsx(p,{className:"h-4 w-4"})}),"director"===I?.role&&"pending"===e.status&&s.jsx("button",{onClick:()=>re(e),className:"p-1 text-mono-600 hover:text-green-900 rounded hover:bg-green-50 transition-colors duration-200",title:"Подтвердить заявку",children:s.jsx(j,{className:"h-4 w-4"})}),"director"===I?.role&&"pending"===e.status&&s.jsx("button",{onClick:()=>ne(e),className:"p-1 text-orange-600 hover:text-orange-900 rounded hover:bg-orange-50 transition-colors duration-200",title:"Установить приоритет",children:s.jsx(v,{className:"h-4 w-4"})}),("director"===I?.role||"accountant"===I?.role)&&"pending"===e.status&&s.jsx("button",{onClick:()=>ee(e),className:"p-1 text-indigo-600 hover:text-indigo-900 rounded hover:bg-indigo-50 transition-colors duration-200",title:"Редактировать",children:s.jsx(N,{className:"h-4 w-4"})}),("director"===I?.role||"accountant"===I?.role)&&"pending"===e.status&&s.jsx("button",{onClick:()=>te(e.id),className:"p-1 text-mono-600 hover:text-red-900 rounded hover:bg-red-50 transition-colors duration-200",title:"Удалить",children:s.jsx(m,{className:"h-4 w-4"})})]}),s.jsxs("div",{className:"mb-4 pr-20",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("h3",{className:"text-lg font-semibold text-mono-900",children:["Заказ #",e.id]}),s.jsxs("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap ${l[e.status]}`,children:[Y(e.status),s.jsx("span",{className:"ml-1",children:i[e.status]})]})]}),s.jsx("p",{className:"text-sm text-mono-600 mb-2",children:e.deliveryObject}),s.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${d[e.priority]}`,children:o[e.priority]})]}),(e.assignedDriverName||e.assignedVehicleNumber)&&s.jsxs("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:[s.jsx("h5",{className:"text-xs font-semibold text-green-800 mb-2",children:"Выполнение"}),s.jsxs("div",{className:"space-y-1",children:[e.assignedDriverName&&s.jsxs("div",{className:"flex items-center text-xs text-mono-700",children:[s.jsx(h,{className:"h-3 w-3 mr-1"}),s.jsx("span",{children:e.assignedDriverName})]}),e.assignedVehicleNumber&&s.jsxs("div",{className:"flex items-center text-xs text-mono-700",children:[s.jsx(b,{className:"h-3 w-3 mr-1"}),s.jsx("span",{children:e.assignedVehicleNumber})]})]})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center text-sm text-mono-600",children:[s.jsx(f,{className:"h-4 w-4 text-mono-400 mr-2 flex-shrink-0"}),s.jsx("span",{className:"truncate",children:e.customerName})]}),s.jsxs("div",{className:"flex items-center text-sm text-mono-600",children:[s.jsx(x,{className:"h-4 w-4 text-mono-400 mr-2 flex-shrink-0"}),s.jsxs("span",{children:[e.concreteGradeName," - ",e.quantity," м³"]})]}),s.jsxs("div",{className:"flex items-center text-sm text-mono-600",children:[s.jsx(f,{className:"h-4 w-4 text-mono-400 mr-2 flex-shrink-0"}),s.jsx("span",{className:"truncate",children:e.warehouseName})]}),s.jsxs("div",{className:"flex items-center text-sm text-mono-600",children:[s.jsx(g,{className:"h-4 w-4 text-mono-400 mr-2 flex-shrink-0"}),s.jsxs("span",{children:[new Date(e.deliveryDateTime).toLocaleDateString("ru-RU")," в"," ",new Date(e.deliveryDateTime).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})]})]}),s.jsxs("div",{className:"flex items-center text-sm text-mono-600",children:[s.jsx(y,{className:"h-4 w-4 text-mono-400 mr-2 flex-shrink-0"}),s.jsx("span",{className:"truncate",children:e.deliveryAddress})]}),K&&e.totalPrice&&s.jsxs("div",{className:"flex items-center text-sm text-mono-600",children:[s.jsx(w,{className:"h-4 w-4 text-mono-400 mr-2 flex-shrink-0"}),s.jsxs("span",{className:"font-medium",children:[e.totalPrice.toLocaleString("ru-RU")," ₸"]})]}),e.additionalServices.length>0&&s.jsxs("div",{className:"text-sm text-mono-600",children:[s.jsx("span",{className:"font-medium",children:"Услуги: "}),e.additionalServices.map(e=>e.serviceName).join(", ")]}),s.jsxs("div",{className:"flex items-center text-sm text-mono-600",children:[s.jsx(h,{className:"h-4 w-4 text-mono-400 mr-2 flex-shrink-0"}),s.jsxs("span",{children:["Создан: ",e.createdByName]})]})]}),e.notes&&s.jsx("div",{className:"mt-4 pt-3 border-t border-mono-200",children:s.jsxs("p",{className:"text-sm text-mono-600",children:[s.jsx("strong",{children:"Примечания:"})," ",e.notes]})})]},e.id))}),s.jsx(O,{isOpen:F,onClose:()=>{W(!1),Z(null)},title:Q?"Редактировать заказ":"Создать заказ",order:Q,onSave:e=>{if(Q){if(!("director"===I?.role||"accountant"===I?.role))return void alert("У вас нет прав для редактирования заказов. Редактировать могут только директор и бухгалтер.");D(s=>s.map(s=>s.id===Q.id?{...s,...e,updatedAt:(new Date).toISOString(),totalPrice:K&&e.price?e.price*(e.quantity||s.quantity)+(e.additionalServices||s.additionalServices).reduce((e,s)=>e+s.total,0):s.totalPrice}:s))}else{const s=P.find(s=>s.id===e.customerId),t=R.find(s=>s.id===e.concreteGradeId),r=$.find(s=>s.id===e.warehouseId),n=!0===s?.autoApprove&&"manager"!==I?.role,a={id:Date.now().toString(),customerId:e.customerId||"",customerName:s?.name||"Неизвестный контрагент",concreteGradeId:e.concreteGradeId||"",concreteGradeName:t?.name||"Неизвестная марка",quantity:e.quantity||0,warehouseId:e.warehouseId||"",warehouseName:r?.name||"Неизвестный склад",deliveryObject:e.deliveryObject||"",deliveryAddress:e.deliveryAddress||"",deliveryDateTime:e.deliveryDateTime||(new Date).toISOString(),price:e.price,totalPrice:K&&e.price&&e.quantity&&e.additionalServices?e.price*e.quantity+e.additionalServices.reduce((e,s)=>e+s.total,0):void 0,additionalServices:e.additionalServices||[],status:n?"confirmed":"pending",priority:"low",notes:e.notes,createdBy:I.id,createdByName:I.fullName||I.login,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),isActive:!0};D(e=>[...e,a])}W(!1),Z(null)},userRole:I?.role||""}),H&&s.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4",children:s.jsx("div",{className:"bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:s.jsxs("div",{className:"p-6",children:[s.jsxs("div",{className:"flex justify-between items-start mb-6",children:[s.jsxs("h3",{className:"text-xl font-semibold text-mono-900",children:["Заказ #",H.id]}),s.jsx("button",{onClick:()=>J(null),className:"text-mono-400 hover:text-mono-600",children:s.jsx("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700",children:"Покупатель"}),s.jsx("p",{className:"mt-1 text-sm text-mono-900",children:H.customerName})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700",children:"Марка бетона"}),s.jsx("p",{className:"mt-1 text-sm text-mono-900",children:H.concreteGradeName})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700",children:"Количество"}),s.jsxs("p",{className:"mt-1 text-sm text-mono-900",children:[H.quantity," м³"]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700",children:"Склад"}),s.jsx("p",{className:"mt-1 text-sm text-mono-900",children:H.warehouseName})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700",children:"Объект доставки"}),s.jsx("p",{className:"mt-1 text-sm text-mono-900",children:H.deliveryObject})]})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700",children:"Адрес доставки"}),s.jsx("p",{className:"mt-1 text-sm text-mono-900",children:H.deliveryAddress})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700",children:"Дата и время доставки"}),s.jsx("p",{className:"mt-1 text-sm text-mono-900",children:new Date(H.deliveryDateTime).toLocaleString("ru-RU")})]}),(H.assignedDriverName||H.assignedVehicleNumber)&&s.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[s.jsx("h4",{className:"text-sm font-semibold text-green-900 mb-3",children:"Информация о выполнении"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[H.assignedDriverName&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-medium text-green-800",children:"Водитель"}),s.jsx("p",{className:"mt-1 text-sm text-green-900",children:H.assignedDriverName})]}),H.assignedVehicleNumber&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-medium text-green-800",children:"Транспорт"}),s.jsx("p",{className:"mt-1 text-sm text-green-900",children:H.assignedVehicleNumber})]}),H.departureTime&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-medium text-green-800",children:"Время отправления"}),s.jsx("p",{className:"mt-1 text-sm text-green-900",children:new Date(H.departureTime).toLocaleString("ru-RU")})]}),H.arrivalTime&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-medium text-green-800",children:"Время прибытия"}),s.jsx("p",{className:"mt-1 text-sm text-green-900",children:new Date(H.arrivalTime).toLocaleString("ru-RU")})]})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700",children:"Статус"}),s.jsxs("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${l[H.status]}`,children:[Y(H.status),s.jsx("span",{className:"ml-1",children:i[H.status]})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700",children:"Приоритет"}),s.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${d[H.priority]}`,children:o[H.priority]})]})]})]}),K&&H.totalPrice&&s.jsx("div",{className:"mt-6 p-4 bg-green-50 rounded-lg",children:s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("span",{className:"text-sm font-medium text-mono-700",children:"Общая стоимость:"}),s.jsxs("span",{className:"text-lg font-bold text-green-900",children:[H.totalPrice.toLocaleString("ru-RU")," ₸"]})]})}),H.additionalServices.length>0&&s.jsxs("div",{className:"mt-6",children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700 mb-2",children:"Дополнительные услуги"}),s.jsx("div",{className:"space-y-2",children:H.additionalServices.map(e=>s.jsxs("div",{className:"flex justify-between items-center p-2 bg-mono-50 rounded",children:[s.jsx("span",{className:"text-sm text-mono-900",children:e.serviceName}),s.jsxs("span",{className:"text-sm font-medium text-mono-900",children:[e.quantity," × ",K?`${e.pricePerUnit.toLocaleString("ru-RU")} ₸ = ${e.total.toLocaleString("ru-RU")} ₸`:"Цена скрыта"]})]},e.serviceId))})]}),H.notes&&s.jsxs("div",{className:"mt-6",children:[s.jsx("label",{className:"block text-sm font-medium text-mono-700 mb-2",children:"Примечания"}),s.jsx("p",{className:"text-sm text-mono-900 bg-mono-50 p-3 rounded",children:H.notes})]}),s.jsx("div",{className:"mt-6 flex justify-end",children:s.jsx("button",{onClick:()=>J(null),className:"px-4 py-2 bg-mono-300 text-mono-700 rounded-lg hover:bg-mono-400 transition-colors duration-200",children:"Закрыть"})})]})})})]})})}export{G as default};
