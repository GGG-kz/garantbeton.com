import{j as e,u as s,b as t,a,R as n}from"./index-DssK2aQr.js";import{r as i}from"./vendor-CPG67Noa.js";import{Q as l,O as r,f as o,U as d,$ as c,a0 as m,a1 as x}from"./ui-DT0cN5GG.js";import"./utils-CHM7ATol.js";import"./forms-BH-hazHY.js";function h({chats:s,onChatSelect:t,selectedChatId:a,currentUserId:n}){const[c,m]=i.useState(""),[x,h]=i.useState(!1),u=s.filter(e=>e.name.toLowerCase().includes(c.toLowerCase())||e.participants.some(e=>e.name.toLowerCase().includes(c.toLowerCase())&&e.id!==n)),p=e=>{const s=new Date(e),t=((new Date).getTime()-s.getTime())/36e5;return t<24?s.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}):t<168?s.toLocaleDateString("ru-RU",{weekday:"short"}):s.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit"})},j=e=>{if("group"===e.type)return e.name;const s=e.participants.find(e=>e.id!==n);return s?.name||e.name},f=(s,t)=>{const a=t?"h-5 w-5 text-black":"h-5 w-5 text-mono-600";return"group"===s.type?e.jsx(d,{className:a}):e.jsx(o,{className:a})};return e.jsxs("div",{className:"w-full md:w-80 bg-white border-r border-mono-200 flex flex-col h-full",children:[e.jsxs("div",{className:"p-6 border-b border-mono-200 bg-mono-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-black",children:"Чаты"}),e.jsx("button",{onClick:()=>h(!0),className:"btn-ghost p-2.5 rounded-xl mobile-touch-target",children:e.jsx(l,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(r,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 h-4 w-4 text-mono-400"}),e.jsx("input",{type:"text",placeholder:"Поиск чатов...",value:c,onChange:e=>m(e.target.value),className:"input-field pl-11 text-sm"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:0===u.length?e.jsxs("div",{className:"p-8 text-center text-mono-500 animate-fade-in",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 bg-mono-100 rounded-2xl flex items-center justify-center",children:e.jsx(o,{className:"h-8 w-8 text-mono-400"})}),e.jsx("p",{className:"text-sm font-semibold text-mono-700",children:"Нет чатов"}),e.jsx("p",{className:"text-xs text-mono-500 mt-1",children:"Создайте новый чат или дождитесь сообщений"})]}):e.jsx("div",{className:"space-y-1 p-2",children:u.map((s,n)=>e.jsx("div",{onClick:()=>t(s),className:"group p-4 cursor-pointer transition-all duration-300 mobile-touch-target rounded-lg animate-slide-up "+(a===s.id?"bg-black text-white":"hover:bg-mono-100 active:bg-mono-200"),style:{animationDelay:50*n+"ms"},children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"h-12 w-12 rounded-lg flex items-center justify-center transition-all duration-300 "+(a===s.id?"bg-white":"bg-mono-200 group-hover:bg-mono-300"),children:f(s,a===s.id)})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h3",{className:"text-sm font-semibold truncate "+(a===s.id?"text-white":"text-black"),children:j(s)}),e.jsxs("div",{className:"flex items-center space-x-2 flex-shrink-0",children:[s.lastMessageAt&&e.jsx("span",{className:"text-xs text-mono-500 font-medium",children:p(s.lastMessageAt)}),s.unreadCount>0&&e.jsx("span",{className:"inline-flex items-center justify-center px-2 py-1 text-xs font-bold rounded-full min-w-[20px] animate-bounce-soft "+(a===s.id?"bg-white text-black":"bg-black text-white"),children:s.unreadCount>99?"99+":s.unreadCount})]})]}),s.lastMessage&&e.jsxs("p",{className:"text-sm truncate "+(a===s.id?"text-mono-300":"text-mono-600"),children:[e.jsxs("span",{className:"font-medium "+(a===s.id?"text-mono-200":"text-mono-700"),children:[s.lastMessage.senderName,":"]})," ",s.lastMessage.content]}),"group"===s.type&&e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx(d,{className:"h-3 w-3 text-mono-400 mr-1"}),e.jsxs("span",{className:"text-xs text-mono-500 font-medium",children:[s.participants.length," участников"]})]})]})]})},s.id))})})]})}function u({chat:t,messages:a,onSendMessage:n,onBackToChats:l}){const{user:r}=s(),[h,u]=i.useState(""),[p,j]=i.useState(null),f=i.useRef(null),b=t?a.filter(e=>e.chatId===t.id).sort((e,s)=>new Date(e.timestamp).getTime()-new Date(s.timestamp).getTime()):[];i.useEffect(()=>{g()},[b]);const g=()=>{f.current?.scrollIntoView({behavior:"smooth"})},N=e=>{const s=new Date(e),t=new Date,a=new Date(t);return a.setDate(a.getDate()-1),s.toDateString()===t.toDateString()?"Сегодня":s.toDateString()===a.toDateString()?"Вчера":s.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric"})},v=e=>{switch(e){case"director":case"dispatcher":return"text-black bg-mono-100";case"manager":return"text-mono-800 bg-mono-100";case"supply":return"text-mono-700 bg-mono-100";case"driver":default:return"text-mono-600 bg-mono-100";case"accountant":return"text-mono-900 bg-mono-100"}};return t?e.jsxs("div",{className:"flex-1 flex flex-col bg-white",children:[e.jsx("div",{className:"p-6 border-b border-mono-200 bg-mono-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[l&&e.jsx("button",{onClick:l,className:"md:hidden p-2.5 text-mono-500 hover:text-mono-700 hover:bg-mono-100 rounded-xl mobile-touch-target transition-all duration-200 hover:scale-105 active:scale-95",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("div",{className:"h-12 w-12 rounded-lg bg-black flex items-center justify-center",children:"group"===t.type?e.jsx(d,{className:"h-6 w-6 text-white"}):e.jsx(o,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-black",children:t.name}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-2 h-2 bg-mono-800 rounded-full animate-pulse"}),e.jsxs("p",{className:"text-sm text-mono-600 font-medium",children:[t.participants.length," участников"]})]})]})]}),e.jsx("button",{className:"p-2.5 text-mono-500 hover:text-mono-700 hover:bg-mono-100 rounded-xl mobile-touch-target transition-all duration-200 hover:scale-105 active:scale-95",children:e.jsx(c,{className:"h-5 w-5"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[0===b.length?e.jsxs("div",{className:"text-center text-mono-500 mt-16 p-8 animate-fade-in",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-4 bg-mono-100 rounded-3xl flex items-center justify-center",children:e.jsx(o,{className:"h-10 w-10 text-mono-400"})}),e.jsx("p",{className:"font-semibold text-mono-700 text-lg",children:"Нет сообщений"}),e.jsx("p",{className:"text-sm mt-2 text-mono-500",children:"Начните общение, отправив первое сообщение"})]}):b.map((s,t)=>{const a=b[t-1],n=s.senderId===r?.id,i=((e,s)=>{if(!s)return!0;const t=new Date(e.timestamp),a=new Date(s.timestamp);return t.toDateString()!==a.toDateString()})(s,a),l=((e,s)=>{if(!s)return!0;if(e.senderId!==s.senderId)return!0;const t=new Date(e.timestamp),a=new Date(s.timestamp);return(t.getTime()-a.getTime())/6e4>5})(s,a);return e.jsxs("div",{children:[i&&e.jsx("div",{className:"flex justify-center my-6",children:e.jsx("span",{className:"px-4 py-2 text-xs font-semibold text-mono-600 bg-mono-100 rounded-full shadow-soft",children:N(s.timestamp)})}),e.jsx("div",{className:`flex ${n?"justify-end":"justify-start"} ${l?"mt-4":"mt-2"} animate-slide-up`,children:e.jsxs("div",{className:`flex max-w-xs md:max-w-sm lg:max-w-md ${n?"flex-row-reverse":"flex-row"} items-end space-x-3`,children:[l&&!n&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"h-8 w-8 rounded-full bg-gradient-to-br from-mono-200 to-mono-300 flex items-center justify-center shadow-soft",children:e.jsx("span",{className:"text-xs font-bold text-mono-700",children:s.senderName.split(" ").map(e=>e[0]).join("")})})}),e.jsxs("div",{className:"flex flex-col "+(n?"items-end":"items-start"),children:[l&&!n&&e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("span",{className:"text-xs font-semibold text-mono-900",children:s.senderName}),e.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${v(s.senderRole)}`,children:s.senderRole})]}),s.replyTo&&e.jsx("div",{className:"mb-2 p-3 bg-mono-50 border-l-4 border-mono-400 rounded-lg text-xs text-mono-600 shadow-soft",children:e.jsx("div",{className:"font-medium text-mono-700",children:"Ответ на сообщение"})}),e.jsx("div",{className:"px-4 py-3 rounded-lg transition-all duration-300 "+(n?"bg-black text-white":"bg-white border-2 border-mono-200 text-black hover:border-mono-300"),children:e.jsx("p",{className:"text-sm leading-relaxed",children:s.content})}),e.jsx("span",{className:"text-xs text-mono-500 mt-1 px-2 font-medium",children:(o=s.timestamp,new Date(o).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}))})]})]})})]},s.id);var o}),e.jsx("div",{ref:f})]}),p&&e.jsx("div",{className:"px-6 py-4 bg-mono-100 border-t border-mono-200 animate-slide-down",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("p",{className:"text-sm font-semibold text-black",children:["Ответ на сообщение от ",p.senderName]}),e.jsx("p",{className:"text-xs text-mono-700 truncate mt-1",children:p.content})]}),e.jsx("button",{onClick:()=>j(null),className:"text-mono-600 hover:text-black p-2 mobile-touch-target rounded-lg hover:bg-mono-200 transition-all duration-300",children:e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),e.jsx("div",{className:"p-6 border-t border-mono-200 bg-mono-50",children:e.jsxs("form",{onSubmit:e=>{e.preventDefault(),h.trim()&&t&&r&&(n(h.trim(),p?.id),u(""),j(null))},className:"flex items-end space-x-3",children:[e.jsx("button",{type:"button",className:"btn-ghost p-3 rounded-xl mobile-touch-target",children:e.jsx(m,{className:"h-5 w-5"})}),e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",value:h,onChange:e=>u(e.target.value),placeholder:"Напишите сообщение...",className:"input-field rounded-2xl text-base resize-none"})}),e.jsx("button",{type:"submit",disabled:!h.trim(),className:"btn-primary p-3 rounded-2xl mobile-touch-target",children:e.jsx(x,{className:"h-5 w-5"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center bg-mono-50",children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx(o,{className:"h-16 w-16 mx-auto mb-4 text-mono-300"}),e.jsx("h3",{className:"text-lg font-medium text-mono-900 mb-2",children:"Выберите чат"}),e.jsx("p",{className:"text-mono-500",children:"Выберите чат из списка слева, чтобы начать общение"})]})})}function p({chats:s,messages:t,selectedChat:a,onChatSelect:n,onSendMessage:l,currentUserId:r}){const[o,d]=i.useState("chats");return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"md:hidden bg-white border-b border-mono-200",children:e.jsxs("div",{className:"flex",children:[e.jsx("button",{onClick:()=>d("chats"),className:"flex-1 py-3 px-4 text-sm font-medium transition-colors duration-200 "+("chats"===o?"text-primary-600 border-b-2 border-primary-600 bg-primary-50":"text-mono-500 hover:text-mono-700"),children:"Чаты"}),e.jsx("button",{onClick:()=>d("messages"),disabled:!a,className:"flex-1 py-3 px-4 text-sm font-medium transition-colors duration-200 "+("messages"===o&&a?"text-primary-600 border-b-2 border-primary-600 bg-primary-50":"text-mono-500 hover:text-mono-700 disabled:text-mono-300"),children:a?a.name:"Сообщения"})]})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:"chats"===o?e.jsx(h,{chats:s,onChatSelect:e=>{n(e),d("messages")},selectedChatId:a?.id,currentUserId:r}):e.jsx(u,{chat:a,messages:t,onSendMessage:l,onBackToChats:()=>{d("chats")}})})]})}const j=[],f=[];function b(){const{user:l}=s(),{isNative:r}=t(),[d,c]=i.useState(null),[m,x]=a("chats",j),[b,g]=a("messages",f),N=d?.id,v=e=>{c(e),e.unreadCount>0&&(g(s=>s.map(s=>s.chatId!==e.id||s.isRead?s:{...s,isRead:!0})),x(s=>s.map(s=>s.id===e.id?{...s,unreadCount:0}:s)))},w=(e,s)=>{if(!l||!d)return;const t={id:Date.now().toString(),senderId:l.id,senderName:l.fullName||l.login,senderRole:l.role,chatId:d.id,chatType:d.type,recipientId:"private"===d.type?d.participants.find(e=>e.id!==l.id)?.id:void 0,recipientName:"private"===d.type?d.participants.find(e=>e.id!==l.id)?.name:void 0,recipientRole:"private"===d.type?d.participants.find(e=>e.id!==l.id)?.role:void 0,content:e,messageType:"text",timestamp:(new Date).toISOString(),isRead:!1,replyTo:s};g(e=>[...e,t]),x(e=>e.map(e=>e.id===d.id?{...e,lastMessage:t,lastMessageAt:t.timestamp,unreadCount:"group"===d.type?e.unreadCount+1:e.unreadCount}:e))};return l?r||window.innerWidth<768?e.jsx(p,{chats:m,messages:b,selectedChat:d,onChatSelect:v,onSendMessage:w,currentUserId:l.id}):e.jsxs(n,{children:[e.jsxs("div",{className:"card overflow-hidden h-[600px] md:h-[700px] flex",children:[e.jsx("div",{className:"md:hidden w-full",children:d?e.jsx(u,{chat:d,messages:b,onSendMessage:w,onBackToChats:()=>c(null)}):e.jsx(h,{chats:m,onChatSelect:v,selectedChatId:N,currentUserId:l.id})}),e.jsxs("div",{className:"hidden md:flex w-full",children:[e.jsx(h,{chats:m,onChatSelect:v,selectedChatId:N,currentUserId:l.id}),e.jsx(u,{chat:d,messages:b,onSendMessage:w})]})]}),e.jsxs("div",{className:"mt-8 grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx("div",{className:"card-interactive animate-slide-up",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-mono-700 text-sm uppercase tracking-wide",children:"Всего чатов"}),e.jsx("p",{className:"text-3xl font-bold text-black mt-2",children:m.length})]}),e.jsx("div",{className:"p-4 bg-black rounded-lg group-hover:scale-110 transition-transform duration-300",children:e.jsx(o,{className:"h-8 w-8 text-white"})})]})}),e.jsx("div",{className:"card-interactive animate-slide-up",style:{animationDelay:"100ms"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-mono-700 text-sm uppercase tracking-wide",children:"Активные чаты"}),e.jsx("p",{className:"text-3xl font-bold text-black mt-2",children:m.filter(e=>e.isActive).length})]}),e.jsx("div",{className:"p-4 bg-mono-800 rounded-lg group-hover:scale-110 transition-transform duration-300",children:e.jsx(o,{className:"h-8 w-8 text-white"})})]})}),e.jsx("div",{className:"card-interactive animate-slide-up",style:{animationDelay:"200ms"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-mono-700 text-sm uppercase tracking-wide",children:"Непрочитанные"}),e.jsx("p",{className:"text-3xl font-bold text-black mt-2",children:m.reduce((e,s)=>e+s.unreadCount,0)})]}),e.jsx("div",{className:"p-4 bg-mono-600 rounded-lg group-hover:scale-110 transition-transform duration-300",children:e.jsx(o,{className:"h-8 w-8 text-white"})})]})})]}),e.jsxs("div",{className:"mt-8 card-primary animate-fade-in",children:[e.jsxs("div",{className:"flex items-start space-x-4 mb-6",children:[e.jsx("div",{className:"p-3 bg-black rounded-lg",children:e.jsx(o,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xl font-bold text-black mb-2",children:"О мессенджере"}),e.jsx("p",{className:"text-mono-600 leading-relaxed",children:"Внутренняя система общения для координации работы между сотрудниками. Поддерживает личные и групповые чаты с минималистичным интерфейсом."})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h5",{className:"font-semibold text-black flex items-center",children:[e.jsx("div",{className:"w-2 h-2 bg-black rounded-full mr-2"}),"Функции"]}),e.jsx("div",{className:"space-y-2",children:["Отправка сообщений","Ответы на сообщения","Групповые чаты","Уведомления в реальном времени"].map((s,t)=>e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-mono-600",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-mono-800 rounded-full"}),e.jsx("span",{children:s})]},t))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h5",{className:"font-semibold text-black flex items-center",children:[e.jsx("div",{className:"w-2 h-2 bg-black rounded-full mr-2"}),"Доступ"]}),e.jsx("p",{className:"text-sm text-mono-600 leading-relaxed",children:"Все сотрудники могут использовать мессенджер для общения и координации работы. Система поддерживает ролевую модель доступа."})]})]})]})]}):e.jsx(n,{children:e.jsx("div",{className:"flex items-center justify-center min-h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-medium text-mono-900 mb-2",children:"Доступ запрещен"}),e.jsx("p",{className:"text-mono-600",children:"Необходимо войти в систему"})]})})})}export{b as default};
